<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" />
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.5.min.css" />
        <title>SRES Companion</title>
		
		<!-- Javascript -->
        <script type="text/javascript" src="phonegap.js"></script>
		<script type="text/javascript" src="js/jquery-2.2.2.min.js"></script>
		<script>
			$(document).bind('mobileinit',function(){
				$.mobile.changePage.defaults.changeHash = false;
				$.mobile.hashListeningEnabled = false;
				$.mobile.pushStateEnabled = false;
				// Globals
				$.sres = {};
				var session = {};
			});
		</script>
		<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
		<script type="text/javascript" src="js/moment-2.12.0.js"></script>
		
		
		
		
		
		<script type="text/javascript" src="js/sres.js"></script>
		<script>
			document.addEventListener("deviceready", onDeviceReady, false);
			function onDeviceReady() {
				// Now safe to use device APIs
			}
			
			$(document).one('pagebeforecreate', function() {
				$( "body>[data-role='panel']" ).panel();
				$("div[data-role=header]").toolbar();
				$.sres.clearSession();
			});
			$(document).on("pagecontainerbeforeshow", function(event, ui) {
				$.sres.loadHeader();
				$("#leftpanel_scancontrolcode").bind("click", function(){ $.sres.canControlCode() });
				$("#leftpanel_identifyperson").bind("click", function(){ $.sres.identifyPerson() });
				$("#leftpanel_logout").bind("click", function(){ $.sres.logout() });
			});
			
			
			$(document).on("pagecreate", "#login", function() {
				var storage = window.localStorage;
				// Fetch stored login_target if exists
				var loginTarget = storage.getItem('login_target');
				if (loginTarget) {
					$("select[id=login_target]").val(loginTarget).selectmenu('refresh');
				}
				// Login button event handler
				$("#login_submit").bind("click", function() {
					// Authenticate
					var authResult = $.sres.testdata.testAuthenticationResponse; // TODO
					// Process
					if (authResult.result.success) {
						// Login success
						$("input[id=password]").val('');
						storage.setItem('login_target', $("select[id=login_target]").val());
						// Save some session variables
						session.user.username = authResult.user.userid;
						session.user.email = authResult.user.email;
						session.user.authcode = authResult.authcode;
						// Redirect
						$.sres.redirectPage('selectcolumn');
					} else {
						$("#login_failed").show('fast');
						$("input[id=password]").val('').focus();
					}
				});
			}); // pagecreate login
			
			$(document).on("pagecreate", "#scan", function() {
				if ($.isEmptyObject(session.currentColumn)) {
					// No current column specified - redirect
					redirectPage('selectcolumn');
				} else {
					$("#scan_columninfo").append(session.currentColumn.name);
					// Do different things depending on scanmethod
					// TODO
				}
			}); // pagecreate scan

			$(document).on("pagecreate", "#identifyperson", function() {
				// TODO
			}); // pagecreate identifyperson

			$(document).on("pagecreate", "#selectcolumn", function() {
				// Fetch available columns from server
				var availableColumns = $.sres.testdata.testAccessibleColumns; // TODO
				// Show
				var html = '';
				availableColumns.forEach(function(table){
					html += '<div data-role="collapsible" data-inset="false">';
					html += '<h3>' + table.metadata.name + '</h3>';
					html += '<ul data-role="listview">';
					table.columns.forEach(function(column){
						html += '<li><a href="javascript:$.sres.activateColumn(\'' + column._id + '\')">' + column.name + '</a></li>';
					});
					html += '</ul>';
					html += '</div>';
				});
				$("#selectcolumn_columnlist").append(html).trigger('create');
			}); // pagecreate selectcolumn
			
		</script>
		
    </head>
    <body>
		
		<!-- Login page -->
		<div data-role="page" id="login">
			<div role="main" class="ui-content">
				<div>
					<input type="text" name="username" id="username" value="" placeholder="Username">
					<input type="password" name="password" id="password" value="" placeholder="Password">
					<select name="login_target" id="login_target">
						<option value="https://scilearn.sydney.edu.au/sres/">University of Sydney</option>
						<option value="https://sres.otago.ac.nz/app/">University of Otago</option>
					</select>
					<input type="button" name="login_submit" id="login_submit" value="Log in">
				</div>
				<div id="login_failed" style="display:none;">
					Sorry, authentication failed with those login details. Please try again.
				</div>
			</div><!-- /content -->
		</div><!-- /page -->
		
		<!-- Select column page -->
		<div data-role="page" id="selectcolumn">
			<div role="main" class="ui-content">
				<div>
					<h2>Select column</h2>
				</div>
				<div id="selectcolumn_columnlist">
					<!-- Space to list tables and columns -->
				</div>
			</div><!-- /content -->
		</div><!-- /page -->
		
		<!-- Main scan page -->
		<div data-role="page" id="scan">
			<div role="main" class="ui-content">
				<div id="scan_columninfo">
				</div>
				<div id="scan_displaydata">
				</div>
				<div id="scan_actions">
					<form class="ui-filterable">
						<input id="scan_search" data-type="search" placeholder="Find a person...">
					</form>
					<button class="ui-btn ui-icon-camera ui-btn-icon-left" id="scan_scanner">Scan</button>
				</div>
			</div><!-- /content -->
		</div><!-- /page -->
		
		<!-- Identify a person page -->
		<div data-role="page" id="identifyperson">
			<div role="main" class="ui-content">
				<div id="identifyperson_displaydata">
					
				</div>
				<div id="identifyperson_actions">
					<form class="ui-filterable">
						<input id="identifyperson_search" data-type="search" placeholder="Find a person...">
					</form>
					<button class="ui-btn ui-icon-camera ui-btn-icon-left" id="identifyperson_scanner">Scan</button>
				</div>
			</div><!-- /content -->
		</div><!-- /page -->
		
		<!-- General header -->
		<div data-role="header" data-position="fixed" data-theme="a">
			<a href="#leftpanel" class="ui-btn-left ui-btn ui-btn-icon-notext ui-icon-bars" style="display:none;" data-loggedin></a>
			<h1 style="display:none;" data-loggedin>SRES</h1>
			<h1 data-loggedout>SRES - Log in</h1>
		</div><!-- /header -->
		
		<!-- Div for left panel -->
		<div data-role="panel" id="leftpanel" data-position="left" data-display="overlay" data-theme="a">
			<div data-role="controlgroup">
				<button class="ui-btn ui-btn-icon-left ui-icon-grid" id="leftpanel_scancontrolcode">Scan a control code</button>
				<button class="ui-btn ui-btn-icon-left ui-icon-user" id="leftpanel_identifyperson">Identify person</button>
				<button class="ui-btn ui-btn-icon-left ui-icon-power" id="leftpanel_logout">Log out</button>
				<button data-rel="close" class="ui-btn ui-icon-delete ui-btn-icon-left">Hide menu</button>
			</div>
		</div><!-- /leftpanel -->
		
		<!-- Template page -->
		<div data-role="page" id="page_template">
			<div role="main" class="ui-content">
				<div>
				</div>
			</div><!-- /content -->
		</div><!-- /page -->
		
    </body>
</html>
